name: Deploy to AppService

on:
  push:
    branches:
      - main # Replace with your desired branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push Docker image
        run: |
          # Define variables
          ACR_NAME=tmp
          IMAGE_NAME=myflaskapp
          TAG=$(echo $GITHUB_SHA | cut -c1-7)  # Use the first 7 characters of the commit hash as a tag

          # Build and push the Docker image to Azure Container Registry
          docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:$TAG .
          docker login $ACR_NAME.azurecr.io -u $ACR_NAME -p ${{ secrets.ACR_PASSWORD }}
          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:$TAG

        env:
          ACR_NAME: ${{ secrets.ACR_NAME }}

      - name: Deploy to Azure App Service
        run: |
          # Define variables
          RESOURCE_GROUP=myresourcegroup
          APP_NAME=myappname
          ACR_NAME=myacrname
          TAG=$(echo $GITHUB_SHA | cut -c1-7)  # Use the first 7 characters of the commit hash as a tag

          # Configure Azure CLI to use ACR for the container image
          az webapp config container set \
            --name $APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --docker-custom-image-name $ACR_NAME.azurecr.io/$IMAGE_NAME:$TAG \
            --docker-registry-server-url https://$ACR_NAME.azurecr.io \
            --docker-registry-server-user $ACR_NAME \
            --docker-registry-server-password ${{ secrets.ACR_PASSWORD }}

          # Restart the Azure App Service to apply changes
          az webapp restart --name $APP_NAME --resource-group $RESOURCE_GROUP

        env:
          RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
          APP_NAME: ${{ secrets.APP_NAME }}
          ACR_NAME: ${{ secrets.ACR_NAME }}
